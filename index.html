<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒŠãƒƒã‚¯ã‚»ãƒ–ãƒ³ã‚¹ãƒªãƒ¼ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Bebas+Neue&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ff0066;
            --primary-dark: #cc0052;
            --secondary: #00ccff;
            --dark: #0a0a0a;
            --dark-lighter: #1a1a1a;
            --dark-card: #151515;
            --text: #ffffff;
            --text-dim: #888888;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff3355;
            --border: #333333;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,0,102,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0,204,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            background: rgba(10,10,10,0.8);
            min-height: 100vh;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 100px rgba(255,0,102,0.2);
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(255,0,102,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 3px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            font-size: 16px;
            color: var(--text-dim);
            backdrop-filter: blur(8px);
        }
        #loadingOverlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-tabs {
            display: flex;
            background: var(--dark-card);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 72px;
            z-index: 99;
            overflow-x: auto;
        }
        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-family: 'Noto Sans JP', sans-serif;
            white-space: nowrap;
            min-width: 60px;
        }
        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(255,0,102,0.05);
        }
        .content { padding: 20px; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group { margin-bottom: 15px; }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-dim);
            font-weight: 500;
        }
        .form-label .required {
            color: var(--primary);
            margin-left: 4px;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,0,102,0.1);
        }
        select.form-control { cursor: pointer; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans JP', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255,0,102,0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,0,102,0.4); }
        .btn-secondary { background: var(--dark-lighter); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00cc66 100%);
            color: var(--dark);
            font-weight: 700;
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #cc8800 100%);
            color: var(--dark);
            font-weight: 700;
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #cc0022 100%);
            color: white;
            font-weight: 700;
        }
        .btn-block { width: 100%; }
        .drink-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--dark-lighter);
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
        }
        .drink-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .drink-item-label { font-size: 13px; color: var(--secondary); font-weight: 600; }
        .drink-item-row { display: flex; gap: 10px; align-items: flex-end; }
        .drink-item .form-group { margin: 0; flex: 1; }
        .drink-item .btn { padding: 8px 12px; font-size: 13px; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card {
            background: var(--dark-lighter);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        .stat-label { font-size: 12px; color: var(--text-dim); margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text); }
        .stat-value.large { font-size: 32px; color: var(--primary); }
        .list-item {
            background: var(--dark-lighter);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .list-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,204,255,0.2); }
        .list-item.active-invoice { border-left-color: var(--warning); }
        .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .list-item-title { font-weight: 700; font-size: 16px; }
        .list-item-meta { font-size: 13px; color: var(--text-dim); }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-primary { background: rgba(255,0,102,0.2); color: var(--primary); }
        .badge-success { background: rgba(0,255,136,0.2); color: var(--success); }
        .badge-warning { background: rgba(255,170,0,0.2); color: var(--warning); }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background: var(--dark-card);
            border-radius: 12px;
            width: 100%;
            max-width: 440px;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
            margin-top: 20px;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--dark-card);
            border-radius: 12px 12px 0 0;
            z-index: 10;
        }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--primary); }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px; height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-body { padding: 20px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar select { flex: 1; min-width: 150px; }
        .summary-section {
            background: linear-gradient(135deg, rgba(255,0,102,0.1) 0%, rgba(0,204,255,0.1) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--primary);
        }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
        .empty-state-icon { font-size: 48px; margin-bottom: 10px; opacity: 0.5; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .total-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(255,0,102,0.3);
        }
        .total-label { font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 5px; }
        .total-amount { font-size: 36px; font-weight: 900; font-family: 'Bebas Neue', cursive; letter-spacing: 2px; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .invoice-action-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cross-table-wrap { overflow-x: auto; margin-top: 10px; }
        .cross-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 320px;
        }
        .cross-table th, .cross-table td {
            padding: 8px 10px;
            border: 1px solid var(--border);
            text-align: right;
            white-space: nowrap;
        }
        .cross-table th {
            background: var(--dark-lighter);
            color: var(--secondary);
            font-weight: 600;
            text-align: center;
        }
        .cross-table th:first-child { text-align: left; color: var(--primary); }
        .cross-table td:first-child { text-align: left; font-weight: 600; }
        .cross-table tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
        .cross-table .total-row td { color: var(--warning); font-weight: 700; background: rgba(255,170,0,0.05); }
        .cross-table .zero { color: var(--border); }
        .box-num-row { display: none; margin-top: 8px; }
        .box-num-row.visible { display: block; }
        .box-num-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .box-num-btn {
            flex: 1;
            min-width: 60px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--dark-lighter);
            color: var(--text-dim);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            letter-spacing: 1px;
        }
        .box-num-btn.selected {
            border-color: var(--secondary);
            background: rgba(0,204,255,0.15);
            color: var(--secondary);
        }
        @media (max-width: 480px) { .stat-grid { grid-template-columns: 1fr; } }
        /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
        .counter-wrap {
            display: flex;
            align-items: center;
            gap: 0;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            height: 46px;
        }
        .counter-btn {
            width: 46px;
            height: 46px;
            background: var(--dark-card);
            border: none;
            color: var(--text);
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
            flex-shrink: 0;
            line-height: 1;
        }
        .counter-btn:active { background: var(--primary); color: white; }
        .counter-btn.minus:active { background: var(--border); }
        .counter-val {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            pointer-events: none;
            min-width: 32px;
        }
        .counter-wrap.drink-counter { border-color: var(--secondary); }
        .counter-wrap.drink-counter .counter-btn { background: rgba(0,204,255,0.08); }
        .counter-wrap.drink-counter .counter-btn:active { background: var(--secondary); color: var(--dark); }

        /* â”€â”€ ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ· â”€â”€ */
        #receiptPrintArea { display: none; }
        @media print {
            body * { visibility: hidden !important; }
            #receiptPrintArea { display: block !important; }
            #receiptPrintArea, #receiptPrintArea * { visibility: visible !important; }
            #receiptPrintArea {
                position: fixed !important;
                top: 0; left: 0;
                width: 80mm;
                padding: 4mm;
                background: white !important;
                color: black !important;
            }
        }
        .receipt-wrap {
            font-family: 'Noto Sans JP', monospace;
            background: white;
            color: #111;
            width: 100%;
            padding: 16px 12px;
            font-size: 13px;
            line-height: 1.8;
        }
        .receipt-shop {
            text-align: center;
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 6px;
            margin-bottom: 2px;
        }
        .receipt-sub {
            text-align: center;
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
        }
        .receipt-divider {
            border: none;
            border-top: 1px dashed #999;
            margin: 8px 0;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 1px 0;
        }
        .receipt-row.indent {
            padding-left: 14px;
            font-size: 12px;
            color: #444;
        }
        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 900;
            padding: 6px 0 2px;
        }
        .receipt-footer {
            text-align: center;
            font-size: 11px;
            color: #888;
            margin-top: 10px;
            line-height: 1.9;
        }
    </style>
</head>
<body>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="app-container">
    <div class="header">
        <h1>SNACK73</h1>
    </div>
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('invoice',this)">ä¼ç¥¨</button>
        <button class="nav-tab" onclick="switchTab('drinks',this)">ãƒ‰ãƒªãƒ³ã‚¯</button>
        <button class="nav-tab" onclick="switchTab('salary',this)">çµ¦æ–™</button>
        <button class="nav-tab" onclick="switchTab('sales',this)">å£²ä¸Š</button>
        <button class="nav-tab" onclick="switchTab('customer',this)">é¡§å®¢</button>
    </div>

    <!-- ä¼ç¥¨ -->
    <div id="invoice" class="section active">
        <div class="content">
            <div class="card">
                <div class="card-title">ğŸ§¾ é€²è¡Œä¸­ã®ä¼ç¥¨</div>
                <div id="activeInvoices"></div>
                <button class="btn btn-success btn-block" onclick="createNewInvoice()">+ æ–°è¦ä¼ç¥¨ã‚’ä½œæˆ</button>
            </div>
            <div class="card">
                <div class="card-title">âœ… æœ¬æ—¥ã®ç¢ºå®šä¼ç¥¨</div>
                <div id="completedInvoices"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ‰ãƒªãƒ³ã‚¯è¨­å®š -->
    <div id="drinks" class="section">
        <div class="content">
            <div class="card">
                <div class="card-title">ğŸ¸ ãƒ‰ãƒªãƒ³ã‚¯ç™»éŒ²</div>
                <div class="form-group">
                    <label class="form-label">ãƒ‰ãƒªãƒ³ã‚¯ç¨®é¡</label>
                    <select id="drinkSettingType" class="form-control" onchange="toggleDrinkTypeFields()">
                        <option value="ã‚«ã‚¯ãƒ†ãƒ«">ã‚«ã‚¯ãƒ†ãƒ«</option>
                        <option value="ã‚·ãƒ§ãƒƒãƒˆ">ã‚·ãƒ§ãƒƒãƒˆ</option>
                        <option value="ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³</option>
                        <option value="ãƒ“ãƒ¼ãƒ«">ãƒ“ãƒ¼ãƒ«</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div id="normalDrinkFields">
                    <div class="form-group">
                        <label class="form-label">ãƒ‰ãƒªãƒ³ã‚¯å</label>
                        <input type="text" id="drinkSettingName" class="form-control" placeholder="ä¾‹: ãƒ¢ãƒ’ãƒ¼ãƒˆ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¾¡æ ¼</label>
                        <input type="number" id="drinkSettingPrice" class="form-control" placeholder="ä¾‹: 1200" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯¾è±¡</label>
                        <select id="drinkTarget" class="form-control">
                            <option value="both">ã‚­ãƒ£ã‚¹ãƒˆãƒ»ãŠå®¢æ§˜ ä¸¡æ–¹</option>
                            <option value="cast">ã‚­ãƒ£ã‚¹ãƒˆã®ã¿</option>
                            <option value="customer">ãŠå®¢æ§˜ã®ã¿</option>
                        </select>
                    </div>
                </div>
                <div id="shotDrinkFields" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">ã‚·ãƒ§ãƒƒãƒˆã®ç¨®é¡</label>
                        <select id="shotType" class="form-control" onchange="toggleJagerPrice()">
                            <option value="ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼">ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼ (1æœ¬ Â¥1,000 / 10æœ¬ Â¥800)</option>
                            <option value="ã‚¤ã‚¨ã‚¬ãƒ¼">ã‚¤ã‚¨ã‚¬ãƒ¼</option>
                        </select>
                    </div>
                    <div class="form-group" id="jagerPriceField" style="display:none;">
                        <label class="form-label">ã‚¤ã‚¨ã‚¬ãƒ¼ä¾¡æ ¼</label>
                        <input type="number" id="jagerPrice" class="form-control" placeholder="ä¾‹: 1200" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯¾è±¡</label>
                        <select id="shotTarget" class="form-control">
                            <option value="both">ã‚­ãƒ£ã‚¹ãƒˆãƒ»ãŠå®¢æ§˜ ä¸¡æ–¹</option>
                            <option value="cast">ã‚­ãƒ£ã‚¹ãƒˆã®ã¿</option>
                            <option value="customer">ãŠå®¢æ§˜ã®ã¿</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success btn-block" onclick="addDrinkSetting()">âœ¨ ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </button>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“‹ ç™»éŒ²æ¸ˆã¿ãƒ‰ãƒªãƒ³ã‚¯ä¸€è¦§</div>
                <div id="drinkSettingsList"></div>
            </div>
        </div>
    </div>

    <!-- çµ¦æ–™è¨ˆç®— -->
    <div id="salary" class="section">
        <div class="content">
            <div class="card">
                <div class="card-title">ğŸ’° çµ¦æ–™è¨ˆç®—</div>
                <div class="form-group">
                    <label class="form-label">ã‚­ãƒ£ã‚¹ãƒˆ</label>
                    <select id="salaryCast" class="form-control" onchange="loadCastSalaryData()">
                        <option value="">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æœŸé–“</label>
                    <select id="salaryPeriod" class="form-control" onchange="loadCastSalaryData()">
                        <option value="today">æœ¬æ—¥</option>
                        <option value="month">ä»Šæœˆ</option>
                    </select>
                </div>
                <div id="salaryDetails"></div>
                <div id="workTimeInput" style="display:none;">
                    <div style="border-top:1px solid var(--border);margin:20px 0;padding-top:20px;">
                        <div class="form-label" style="color:var(--primary);margin-bottom:15px;">â° å‹¤å‹™æ™‚é–“ã‚’è¿½åŠ </div>
                        <div class="form-group">
                            <label class="form-label">æ—¥ä»˜</label>
                            <input type="date" id="quickWorkDate" class="form-control">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">é–‹å§‹æ™‚åˆ»</label>
                                <select id="quickWorkStart" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">çµ‚äº†æ™‚åˆ»</label>
                                <select id="quickWorkEnd" class="form-control"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åŒä¼´</label>
                            <select id="quickWorkDohan" class="form-control">
                                <option value="0">ãªã—</option>
                                <option value="1">ã‚ã‚Š</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€è¿ä»£ï¼ˆã“ã®æ—¥ã®ã¿ï¼‰</label>
                            <select id="quickWorkTransport" class="form-control">
                                <option value="-1">ã‚­ãƒ£ã‚¹ãƒˆè¨­å®šã®é€è¿ä»£ã‚’ä½¿ç”¨</option>
                                <option value="0">ãªã— (Â¥0)</option>
                                <option value="500">Â¥500</option>
                                <option value="1000">Â¥1,000</option>
                                <option value="1500">Â¥1,500</option>
                                <option value="2000">Â¥2,000</option>
                                <option value="2500">Â¥2,500</option>
                                <option value="3000">Â¥3,000</option>
                                <option value="4000">Â¥4,000</option>
                                <option value="5000">Â¥5,000</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="saveQuickWorkTime()">ğŸ’¾ å‹¤å‹™æ™‚é–“ã‚’ç™»éŒ²</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">âš™ï¸ ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š</div>
                <div class="form-group">
                    <label class="form-label">ã‚­ãƒ£ã‚¹ãƒˆå</label>
                    <input type="text" id="newCastName" class="form-control" placeholder="ä¾‹: æ¡œ">
                </div>
                <div class="form-group">
                    <label class="form-label">èª•ç”Ÿæ—¥ï¼ˆä»»æ„ï¼‰</label>
                    <input type="date" id="newCastBirthday" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">æ™‚çµ¦</label>
                    <input type="number" id="newCastHourly" class="form-control" placeholder="ä¾‹: 3000" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯è¨­å®š</label>
                    <div class="grid-2">
                        <div>
                            <label class="form-label">ã‚«ã‚¯ãƒ†ãƒ«</label>
                            <input type="number" id="newCastCocktailBack" class="form-control" placeholder="ä¾‹: 500" min="0">
                        </div>
                        <div>
                            <label class="form-label">ã‚·ãƒ§ãƒƒãƒˆ</label>
                            <input type="number" id="newCastShotBack" class="form-control" placeholder="ä¾‹: 800" min="0">
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label class="form-label">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒãƒƒã‚¯ç‡ (%)</label>
                            <input type="number" id="newCastChampagneBackRate" class="form-control" placeholder="ä¾‹: 20" min="0" max="100">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">åŒä¼´ãƒãƒƒã‚¯</label>
                    <input type="number" id="newCastDohanBack" class="form-control" placeholder="ä¾‹: 2000" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">é€è¿ä»£</label>
                    <input type="number" id="newCastTransport" class="form-control" placeholder="ä¾‹: 1000" min="0">
                </div>
                <button class="btn btn-success btn-block" onclick="addCast()">âœ¨ ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ </button>
            </div>
            <div class="card">
                <div class="card-title">ğŸ‘¥ ç™»éŒ²ã‚­ãƒ£ã‚¹ãƒˆ</div>
                <div id="castList"></div>
            </div>
        </div>
    </div>

    <!-- å£²ä¸Š -->
    <div id="sales" class="section">
        <div class="content">
            <div class="card">
                <div class="card-title">ğŸ“Š å£²ä¸Šé›†è¨ˆ</div>
                <div class="filter-bar">
                    <select id="salesPeriod" class="form-control" onchange="onSalesPeriodChange()">
                        <option value="today">æœ¬æ—¥</option>
                        <option value="month">ä»Šæœˆ</option>
                        <option value="monthly">æœˆã”ã¨</option>
                    </select>
                    <select id="salesType" class="form-control" onchange="loadSalesData()">
                        <option value="total">åº—èˆ—å…¨ä½“</option>
                        <option value="customer">é¡§å®¢åˆ¥</option>
                        <option value="cast">ã‚­ãƒ£ã‚¹ãƒˆåˆ¥</option>
                        <option value="cross">é¡§å®¢Ã—ã‚­ãƒ£ã‚¹ãƒˆ</option>
                    </select>
                </div>
                <!-- æœˆé¸æŠï¼ˆæœˆã”ã¨é¸æŠæ™‚ã«è¡¨ç¤ºï¼‰ -->
                <div id="salesMonthRow" style="display:none;margin-bottom:12px;">
                    <select id="salesMonth" class="form-control" onchange="onSalesMonthChange()"></select>
                </div>
                <!-- æ—¥ä»˜é¸æŠï¼ˆæœˆã‚’é¸ã‚“ã ã‚ã¨ã«è¡¨ç¤ºï¼‰ -->
                <div id="salesDayRow" style="display:none;margin-bottom:12px;">
                    <select id="salesDay" class="form-control" onchange="loadSalesData()">
                        <option value="">â”€â”€ æ—¥ä»˜ã‚’é¸æŠï¼ˆæœˆåˆè¨ˆã‚’è¡¨ç¤ºï¼‰</option>
                    </select>
                </div>
                <div id="salesSummary"></div>
                <div id="salesDetails"></div>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢ç®¡ç† -->
    <div id="customer" class="section">
        <div class="content">
            <div class="card">
                <div class="card-title">ğŸ‘¤ é¡§å®¢ç™»éŒ²</div>
                <div class="form-group">
                    <label class="form-label">é¡§å®¢å<span class="required">*</span></label>
                    <input type="text" id="newCustomerName" class="form-control" placeholder="ä¾‹: ç”°ä¸­æ§˜">
                </div>
                <div class="form-group">
                    <label class="form-label">èª•ç”Ÿæ—¥ï¼ˆä»»æ„ï¼‰</label>
                    <input type="date" id="newCustomerBirthday" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="newCustomerMemo" class="form-control" rows="3" placeholder="å¥½ã¿ã®ãƒ‰ãƒªãƒ³ã‚¯ã€è¶£å‘³ãªã©"></textarea>
                </div>
                <button class="btn btn-success btn-block" onclick="addCustomer()">âœ¨ é¡§å®¢ã‚’è¿½åŠ </button>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“‡ é¡§å®¢ä¸€è¦§</div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="customerSearchInput" class="form-control" placeholder="ğŸ” é¡§å®¢åã§æ¤œç´¢..." oninput="renderCustomerList()">
                </div>
                <div id="customerList"></div>
            </div>
        </div>
    </div>
</div>

<!-- é¡§å®¢è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">é¡§å®¢è©³ç´°</div>
            <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
        </div>
        <div class="modal-body" id="customerModalBody"></div>
    </div>
</div>

<!-- ä¼ç¥¨ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="invoiceModalTitle">ä¼ç¥¨ç·¨é›†</div>
            <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">é¡§å®¢å</label>
                <select id="editInvoiceCustomer" class="form-control" onchange="calculateEditInvoice()">
                    <option value="">é¡§å®¢ã‚’é¸æŠ</option>
                </select>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">ã‚»ãƒƒãƒˆæ–™é‡‘</label>
                    <select id="editInvoiceSet" class="form-control" onchange="calculateEditInvoice()">
                        <option value="3000-true">ãƒœãƒˆãƒ«æœ‰ã‚Š (Â¥3,000)</option>
                        <option value="2500-false">ãƒœãƒˆãƒ«ç„¡ã— (Â¥2,500)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">äººæ•°</label>
                    <input type="number" id="editInvoicePeople" class="form-control" value="1" min="1" onchange="calculateEditInvoice()">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">å¸­</label>
                <select id="editInvoiceSeat" class="form-control" onchange="handleSeatChange()">
                    <option value="0">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</option>
                    <option value="1000">ãƒœãƒƒã‚¯ã‚¹ (+Â¥1,000)</option>
                </select>
            </div>
            <div class="box-num-row" id="boxNumRow">
                <label class="form-label">ãƒœãƒƒã‚¯ã‚¹ç•ªå·</label>
                <div class="box-num-btns">
                    <button class="box-num-btn" data-num="1" onclick="selectBoxNum(1)">BOX 1</button>
                    <button class="box-num-btn" data-num="2" onclick="selectBoxNum(2)">BOX 2</button>
                    <button class="box-num-btn" data-num="3" onclick="selectBoxNum(3)">BOX 3</button>
                    <button class="box-num-btn" data-num="4" onclick="selectBoxNum(4)">BOX 4</button>
                </div>
            </div>
            <div class="form-group" id="extensionGroup">
                <label class="form-label">å»¶é•·æ™‚é–“ (30åˆ†å˜ä½)</label>
                <select id="editInvoiceExtension" class="form-control" onchange="calculateEditInvoice()">
                    <option value="0">ãªã—</option>
                    <option value="1">30åˆ†</option>
                    <option value="2">1æ™‚é–“</option>
                    <option value="3">1æ™‚é–“30åˆ†</option>
                    <option value="4">2æ™‚é–“</option>
                    <option value="5">2æ™‚é–“30åˆ†</option>
                    <option value="6">3æ™‚é–“</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ã‚«ãƒ©ã‚ªã‚±æ›²æ•°</label>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div class="counter-wrap" style="flex:1;">
                        <button class="counter-btn minus" onclick="changeKaraoke(-1)">ï¼</button>
                        <div class="counter-val" id="editInvoiceKaraokeVal">0</div>
                        <button class="counter-btn" onclick="changeKaraoke(1)">ï¼‹</button>
                    </div>
                    <input type="hidden" id="editInvoiceKaraoke" value="0">
                    <div style="font-size:13px;color:var(--text-dim);white-space:nowrap;">Ã—Â¥200</div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ãƒ‰ãƒªãƒ³ã‚¯</label>
                <div id="editInvoiceDrinks"></div>
                <button class="btn btn-secondary btn-block" onclick="addEditInvoiceDrink()">+ ãƒ‰ãƒªãƒ³ã‚¯è¿½åŠ </button>
            </div>
            <div class="total-display">
                <div class="total-label">åˆè¨ˆé‡‘é¡</div>
                <div class="total-amount" id="editInvoiceTotal">Â¥0</div>
            </div>
            <div class="invoice-action-btns">
                <button class="btn btn-warning" onclick="saveEditInvoice()">ğŸ’¾ é€”ä¸­ä¿å­˜</button>
                <button class="btn btn-success" onclick="completeInvoice()">âœ… ç¢ºå®š</button>
            </div>
            <button class="btn btn-secondary btn-block" id="printInvoiceBtn" style="display:none;margin-bottom:10px;" onclick="printReceipt(currentEditingInvoiceId)">ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·</button>
            <button class="btn btn-danger btn-block" onclick="deleteInvoice()">ğŸ—‘ï¸ ä¼ç¥¨ã‚’å‰Šé™¤</button>
        </div>
    </div>
</div>

<!-- ã‚­ãƒ£ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editCastModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ã‚­ãƒ£ã‚¹ãƒˆç·¨é›†</div>
            <button class="modal-close" onclick="closeModal('editCastModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editCastId">
            <div class="form-group">
                <label class="form-label">ã‚­ãƒ£ã‚¹ãƒˆå</label>
                <input type="text" id="editCastName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">èª•ç”Ÿæ—¥ï¼ˆä»»æ„ï¼‰</label>
                <input type="date" id="editCastBirthday" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">æ™‚çµ¦</label>
                <input type="number" id="editCastHourly" class="form-control" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯è¨­å®š</label>
                <div class="grid-2">
                    <div>
                        <label class="form-label">ã‚«ã‚¯ãƒ†ãƒ«</label>
                        <input type="number" id="editCastCocktailBack" class="form-control" min="0">
                    </div>
                    <div>
                        <label class="form-label">ã‚·ãƒ§ãƒƒãƒˆ</label>
                        <input type="number" id="editCastShotBack" class="form-control" min="0">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label class="form-label">ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ãƒãƒƒã‚¯ç‡ (%)</label>
                        <input type="number" id="editCastChampagneBackRate" class="form-control" min="0" max="100">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">åŒä¼´ãƒãƒƒã‚¯</label>
                <input type="number" id="editCastDohanBack" class="form-control" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">é€è¿ä»£</label>
                <input type="number" id="editCastTransport" class="form-control" min="0">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button class="btn btn-danger" onclick="deleteCast()">ğŸ—‘ï¸ å‰Šé™¤</button>
                <button class="btn btn-success" onclick="saveEditCast()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editCustomerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">é¡§å®¢ç·¨é›†</div>
            <button class="modal-close" onclick="closeModal('editCustomerModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editCustomerId">
            <div class="form-group">
                <label class="form-label">é¡§å®¢å<span class="required">*</span></label>
                <input type="text" id="editCustomerName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">èª•ç”Ÿæ—¥ï¼ˆä»»æ„ï¼‰</label>
                <input type="date" id="editCustomerBirthday" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                <textarea id="editCustomerMemo" class="form-control" rows="3"></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button class="btn btn-danger" onclick="deleteCustomer()">ğŸ—‘ï¸ å‰Šé™¤</button>
                <button class="btn btn-success" onclick="saveEditCustomer()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å‹¤å‹™æ™‚é–“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editWorkTimeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">å‹¤å‹™æ™‚é–“ã‚’ç·¨é›†</div>
            <button class="modal-close" onclick="closeModal('editWorkTimeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editWorkTimeId">
            <div class="form-group">
                <label class="form-label">æ—¥ä»˜</label>
                <input type="date" id="editWorkDate" class="form-control">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">é–‹å§‹æ™‚åˆ»</label>
                    <select id="editWorkStart" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">çµ‚äº†æ™‚åˆ»</label>
                    <select id="editWorkEnd" class="form-control"></select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">åŒä¼´</label>
                <select id="editWorkDohan" class="form-control">
                    <option value="0">ãªã—</option>
                    <option value="1">ã‚ã‚Š</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">é€è¿ä»£</label>
                <select id="editWorkTransport" class="form-control">
                    <option value="-1">ã‚­ãƒ£ã‚¹ãƒˆè¨­å®šã‚’ä½¿ç”¨</option>
                    <option value="0">ãªã— (Â¥0)</option>
                    <option value="500">Â¥500</option>
                    <option value="1000">Â¥1,000</option>
                    <option value="1500">Â¥1,500</option>
                    <option value="2000">Â¥2,000</option>
                    <option value="2500">Â¥2,500</option>
                    <option value="3000">Â¥3,000</option>
                    <option value="4000">Â¥4,000</option>
                    <option value="5000">Â¥5,000</option>
                </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button class="btn btn-danger" onclick="deleteWorkTime()">ğŸ—‘ï¸ å‰Šé™¤</button>
                <button class="btn btn-success" onclick="saveEditWorkTime()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK (CDN) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
    getFirestore,
    doc,
    getDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â”€â”€ Firebase åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
    apiKey: "AIzaSyAMLRv57b_On4fVhkQKl1fJJOy-WN520wU",
    authDomain: "snack73-a01ee.firebaseapp.com",
    projectId: "snack73-a01ee",
    storageBucket: "snack73-a01ee.firebasestorage.app",
    messagingSenderId: "774954469373",
    appId: "1:774954469373:web:877686a194028cdb707b94"
};
const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);

const DOC_REF = doc(db, "snack73", "main");

// â”€â”€ ãƒ‡ãƒ¼ã‚¿èª­ã¿æ›¸ãï¼ˆFirestoreã«å®Œå…¨ç½®ãæ›ãˆï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._loadData = async function() {
    try {
        const snap = await getDoc(DOC_REF);
        if (snap.exists()) {
            const saved = snap.data().payload ? JSON.parse(snap.data().payload) : {};
            appData = { activeInvoices: [], ...saved };
        }
    } catch(e) {
        console.error('Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
};

window._saveData = async function() {
    try {
        await setDoc(DOC_REF, { payload: JSON.stringify(appData), updatedAt: new Date().toISOString() });
    } catch(e) {
        console.error('Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        throw e;
    }
};

// â”€â”€ ã‚¢ãƒ—ãƒªèµ·å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => { init(); });
</script>

<script>
// â”€â”€ ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let appData = {
    casts: [],
    customers: [],
    invoices: [],
    activeInvoices: [],
    workTimes: [],
    drinkSettings: []
};
let currentEditingInvoiceId = null;
let currentBoxNum = null;

// â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    showLoading(true);
    await window._loadData();
    renderAll();
    document.getElementById('workDate') && (document.getElementById('workDate').value = new Date().toISOString().split('T')[0]);
    showLoading(false);
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

async function loadData() { await window._loadData(); }
async function saveData() { await window._saveData(); }

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tabName, btn) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    if (tabName === 'invoice') { renderActiveInvoices(); renderCompletedInvoices(); }
    if (tabName === 'drinks') renderDrinkSettings();
    if (tabName === 'salary') renderSalarySection();
    if (tabName === 'sales') loadSalesData();
    if (tabName === 'customer') renderCustomerList();
}

// â”€â”€ ãƒ‰ãƒªãƒ³ã‚¯è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDrinkTypeFields() {
    const type = document.getElementById('drinkSettingType').value;
    document.getElementById('normalDrinkFields').style.display = type === 'ã‚·ãƒ§ãƒƒãƒˆ' ? 'none' : 'block';
    document.getElementById('shotDrinkFields').style.display = type === 'ã‚·ãƒ§ãƒƒãƒˆ' ? 'block' : 'none';
}
function toggleJagerPrice() {
    const v = document.getElementById('shotType').value;
    document.getElementById('jagerPriceField').style.display = v === 'ã‚¤ã‚¨ã‚¬ãƒ¼' ? 'block' : 'none';
}
async function addDrinkSetting() {
    const type = document.getElementById('drinkSettingType').value;
    let name, price, isShot = false, shotType = null, target;
    if (type === 'ã‚·ãƒ§ãƒƒãƒˆ') {
        shotType = document.getElementById('shotType').value;
        name = shotType; isShot = true;
        target = document.getElementById('shotTarget').value;
        price = shotType === 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼' ? 1000 : (parseInt(document.getElementById('jagerPrice').value) || 0);
        if (shotType === 'ã‚¤ã‚¨ã‚¬ãƒ¼' && !price) { alert('ã‚¤ã‚¨ã‚¬ãƒ¼ã®ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    } else {
        name = document.getElementById('drinkSettingName').value.trim();
        price = parseInt(document.getElementById('drinkSettingPrice').value) || 0;
        target = document.getElementById('drinkTarget').value;
        if (!name || !price) { alert('ãƒ‰ãƒªãƒ³ã‚¯åã¨ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    }
    showLoading(true);
    appData.drinkSettings.push({ id: Date.now().toString(), type, name, price, isShot, shotType, target });
    await saveData();
    showLoading(false);
    document.getElementById('drinkSettingName').value = '';
    document.getElementById('drinkSettingPrice').value = '';
    document.getElementById('jagerPrice').value = '';
    renderDrinkSettings();
    alert('ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
}
async function deleteDrinkSetting(id) {
    if (!confirm('ã“ã®ãƒ‰ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    showLoading(true);
    appData.drinkSettings = appData.drinkSettings.filter(d => d.id !== id);
    await saveData();
    showLoading(false);
    renderDrinkSettings();
}
function renderDrinkSettings() {
    const c = document.getElementById('drinkSettingsList');
    if (!appData.drinkSettings.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¸</div><div>ãƒ‰ãƒªãƒ³ã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>'; return;
    }
    const groups = ['ã‚«ã‚¯ãƒ†ãƒ«','ã‚·ãƒ§ãƒƒãƒˆ','ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³','ãƒ“ãƒ¼ãƒ«','ãã®ä»–'];
    let html = '';
    groups.forEach(g => {
        const drinks = appData.drinkSettings.filter(d => d.type === g);
        if (!drinks.length) return;
        html += `<div style="margin-bottom:15px;"><div class="form-label" style="color:var(--secondary);">${g}</div>`;
        drinks.forEach(d => {
            const priceText = d.shotType === 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼' ? 'Â¥1,000 (10æœ¬ã§Â¥800/æœ¬)' : `Â¥${d.price.toLocaleString()}`;
            const tBadge = d.target === 'cast' ? '<span class="badge badge-primary" style="margin-left:6px;">ã‚­ãƒ£ã‚¹ãƒˆ</span>'
                         : d.target === 'customer' ? '<span class="badge badge-success" style="margin-left:6px;">ãŠå®¢æ§˜</span>' : '';
            html += `<div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
                <div><div class="list-item-title">${d.name}${tBadge}</div><div class="list-item-meta">${priceText}</div></div>
                <button class="btn btn-secondary" onclick="deleteDrinkSetting('${d.id}');event.stopPropagation();" style="padding:6px 12px;">å‰Šé™¤</button>
            </div>`;
        });
        html += '</div>';
    });
    c.innerHTML = html;
}

// â”€â”€ ã‚­ãƒ£ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCast() {
    const name = document.getElementById('newCastName').value.trim();
    if (!name) { alert('ã‚­ãƒ£ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    showLoading(true);
    appData.casts.push({
        id: Date.now().toString(),
        name,
        birthday: document.getElementById('newCastBirthday').value,
        hourly: parseInt(document.getElementById('newCastHourly').value) || 0,
        drinkBacks: {
            'ã‚«ã‚¯ãƒ†ãƒ«': parseInt(document.getElementById('newCastCocktailBack').value) || 0,
            'ã‚·ãƒ§ãƒƒãƒˆ': parseInt(document.getElementById('newCastShotBack').value) || 0
        },
        champagneBackRate: parseInt(document.getElementById('newCastChampagneBackRate').value) || 0,
        dohanBack: parseInt(document.getElementById('newCastDohanBack').value) || 0,
        transport: parseInt(document.getElementById('newCastTransport').value) || 0
    });
    await saveData();
    showLoading(false);
    ['newCastName','newCastBirthday','newCastHourly','newCastCocktailBack','newCastShotBack','newCastChampagneBackRate','newCastDohanBack','newCastTransport']
        .forEach(id => document.getElementById(id).value = '');
    renderAll();
    alert('ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
}
function renderCastList() {
    const c = document.getElementById('castList');
    if (!appData.casts.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div>ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>'; return;
    }
    c.innerHTML = appData.casts.map(cast => {
        const bdayTxt = cast.birthday ? `èª•ç”Ÿæ—¥: ${cast.birthday}ã€€` : '';
        return `<div class="list-item">
            <div class="list-item-header">
                <div class="list-item-title">${cast.name}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="badge badge-primary">æ™‚çµ¦ Â¥${cast.hourly.toLocaleString()}</span>
                    <button class="btn btn-secondary" style="padding:4px 12px;font-size:12px;" onclick="openEditCast('${cast.id}');event.stopPropagation();">ç·¨é›†</button>
                </div>
            </div>
            <div class="list-item-meta">${bdayTxt}ã‚«ã‚¯ãƒ†ãƒ«: Â¥${cast.drinkBacks['ã‚«ã‚¯ãƒ†ãƒ«']} / ã‚·ãƒ§ãƒƒãƒˆ: Â¥${cast.drinkBacks['ã‚·ãƒ§ãƒƒãƒˆ']} / ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³: ${cast.champagneBackRate}%</div>
        </div>`;
    }).join('');
}

function openEditCast(castId) {
    const cast = appData.casts.find(c => c.id === castId);
    if (!cast) return;
    document.getElementById('editCastId').value = cast.id;
    document.getElementById('editCastName').value = cast.name;
    document.getElementById('editCastBirthday').value = cast.birthday || '';
    document.getElementById('editCastHourly').value = cast.hourly;
    document.getElementById('editCastCocktailBack').value = cast.drinkBacks['ã‚«ã‚¯ãƒ†ãƒ«'];
    document.getElementById('editCastShotBack').value = cast.drinkBacks['ã‚·ãƒ§ãƒƒãƒˆ'];
    document.getElementById('editCastChampagneBackRate').value = cast.champagneBackRate;
    document.getElementById('editCastDohanBack').value = cast.dohanBack;
    document.getElementById('editCastTransport').value = cast.transport;
    openModal('editCastModal');
}

async function saveEditCast() {
    const castId = document.getElementById('editCastId').value;
    const name = document.getElementById('editCastName').value.trim();
    if (!name) { alert('ã‚­ãƒ£ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const idx = appData.casts.findIndex(c => c.id === castId);
    if (idx === -1) return;
    appData.casts[idx] = {
        ...appData.casts[idx],
        name,
        birthday: document.getElementById('editCastBirthday').value,
        hourly: parseInt(document.getElementById('editCastHourly').value) || 0,
        drinkBacks: {
            'ã‚«ã‚¯ãƒ†ãƒ«': parseInt(document.getElementById('editCastCocktailBack').value) || 0,
            'ã‚·ãƒ§ãƒƒãƒˆ': parseInt(document.getElementById('editCastShotBack').value) || 0
        },
        champagneBackRate: parseInt(document.getElementById('editCastChampagneBackRate').value) || 0,
        dohanBack: parseInt(document.getElementById('editCastDohanBack').value) || 0,
        transport: parseInt(document.getElementById('editCastTransport').value) || 0
    };
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editCastModal');
    renderAll();
    alert('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
}

async function deleteCast() {
    const castId = document.getElementById('editCastId').value;
    const cast = appData.casts.find(c => c.id === castId);
    if (!confirm(`ã€Œ${cast?.name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    appData.casts = appData.casts.filter(c => c.id !== castId);
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editCastModal');
    renderAll();
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
}

// â”€â”€ é¡§å®¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCustomer() {
    const name = document.getElementById('newCustomerName').value.trim();
    if (!name) { alert('é¡§å®¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    showLoading(true);
    appData.customers.push({
        id: Date.now().toString(),
        name,
        birthday: document.getElementById('newCustomerBirthday').value,
        memo: document.getElementById('newCustomerMemo').value.trim(),
        createdAt: new Date().toISOString()
    });
    await saveData();
    showLoading(false);
    ['newCustomerName','newCustomerBirthday','newCustomerMemo'].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = '';
    });
    renderAll();
    alert('é¡§å®¢ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
}
function renderCustomerList() {
    const c = document.getElementById('customerList');
    const searchEl = document.getElementById('customerSearchInput');
    const keyword = searchEl ? searchEl.value.trim() : '';
    if (!appData.customers.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div><div>é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>'; return;
    }
    const filtered = keyword
        ? appData.customers.filter(cu => cu.name.includes(keyword))
        : appData.customers;
    if (!filtered.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><div>ã€Œ' + keyword + 'ã€ã«ä¸€è‡´ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>'; return;
    }
    c.innerHTML = filtered.map(cu => {
        const cnt = appData.invoices.filter(i => i.customerId === cu.id).length;
        return `<div class="list-item" onclick="showCustomerDetail('${cu.id}')">
            <div class="list-item-header">
                <div class="list-item-title">${cu.name}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="badge badge-success">${cnt}å›æ¥åº—</span>
                    <button class="btn btn-secondary" style="padding:4px 12px;font-size:12px;" onclick="openEditCustomer('${cu.id}');event.stopPropagation();">ç·¨é›†</button>
                </div>
            </div>
            <div class="list-item-meta">${cu.birthday ? 'èª•ç”Ÿæ—¥: ' + cu.birthday : 'èª•ç”Ÿæ—¥æœªç™»éŒ²'}</div>
        </div>`;
    }).join('');
}

function openEditCustomer(customerId) {
    const cu = appData.customers.find(c => c.id === customerId);
    if (!cu) return;
    document.getElementById('editCustomerId').value = cu.id;
    document.getElementById('editCustomerName').value = cu.name;
    document.getElementById('editCustomerBirthday').value = cu.birthday || '';
    document.getElementById('editCustomerMemo').value = cu.memo || '';
    openModal('editCustomerModal');
}

async function saveEditCustomer() {
    const customerId = document.getElementById('editCustomerId').value;
    const name = document.getElementById('editCustomerName').value.trim();
    if (!name) { alert('é¡§å®¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const idx = appData.customers.findIndex(c => c.id === customerId);
    if (idx === -1) return;
    appData.customers[idx] = {
        ...appData.customers[idx],
        name,
        birthday: document.getElementById('editCustomerBirthday').value,
        memo: document.getElementById('editCustomerMemo').value.trim()
    };
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editCustomerModal');
    renderAll();
    alert('é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
}

async function deleteCustomer() {
    const customerId = document.getElementById('editCustomerId').value;
    const cu = appData.customers.find(c => c.id === customerId);
    if (!confirm(`ã€Œ${cu?.name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    appData.customers = appData.customers.filter(c => c.id !== customerId);
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editCustomerModal');
    renderAll();
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
}

// â”€â”€ ä¼ç¥¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createNewInvoice() {
    const inv = {
        id: Date.now().toString(),
        customerId: '',
        people: 1,
        hasBottle: true,
        setPrice: 3000,
        seatPrice: 0,
        boxNum: null,
        extension: 0,
        karaoke: 0,
        drinks: [],
        status: 'active',
        createdAt: new Date().toISOString(),
        total: 0
    };
    showLoading(true);
    appData.activeInvoices.push(inv);
    await saveData();
    showLoading(false);
    renderActiveInvoices();
    editInvoice(inv.id);
}

function editInvoice(invoiceId) {
    currentEditingInvoiceId = invoiceId;
    const inv = appData.activeInvoices.find(i => i.id === invoiceId);
    if (!inv) return;
    openInvoiceModal(inv, false);
}
function editCompletedInvoice(invoiceId) {
    currentEditingInvoiceId = invoiceId;
    const inv = appData.invoices.find(i => i.id === invoiceId);
    if (!inv) return;
    openInvoiceModal(inv, true);
}
function openInvoiceModal(inv, isCompleted) {
    document.getElementById('invoiceModalTitle').textContent = isCompleted ? 'ä¼ç¥¨ç·¨é›†ï¼ˆç¢ºå®šæ¸ˆï¼‰' : 'ä¼ç¥¨ç·¨é›†';
    const pb = document.getElementById('printInvoiceBtn');
    if (pb) pb.style.display = isCompleted ? 'flex' : 'none';
    renderCustomerSelects();
    document.getElementById('editInvoiceCustomer').value = inv.customerId || '';
    document.getElementById('editInvoiceSet').value = `${inv.setPrice}-${inv.hasBottle}`;
    document.getElementById('editInvoicePeople').value = inv.people || 1;
    document.getElementById('editInvoiceSeat').value = inv.seatPrice || 0;
    document.getElementById('editInvoiceExtension').value = inv.extension || 0;
    const karaokeVal = inv.karaoke || 0;
    document.getElementById('editInvoiceKaraoke').value = karaokeVal;
    document.getElementById('editInvoiceKaraokeVal').textContent = karaokeVal;
    currentBoxNum = inv.boxNum || null;
    handleSeatChange();
    const dc = document.getElementById('editInvoiceDrinks');
    dc.innerHTML = '';
    (inv.drinks || []).forEach(d => addEditInvoiceDrink(d));
    calculateEditInvoice();
    openModal('invoiceModal');
}

function handleSeatChange() {
    const seatVal = document.getElementById('editInvoiceSeat').value;
    const boxRow = document.getElementById('boxNumRow');
    if (seatVal === '1000') {
        boxRow.classList.add('visible');
        document.querySelectorAll('.box-num-btn').forEach(btn => {
            btn.classList.toggle('selected', parseInt(btn.dataset.num) === currentBoxNum);
        });
    } else {
        boxRow.classList.remove('visible');
        currentBoxNum = null;
    }
    calculateEditInvoice();
}

function selectBoxNum(num) {
    currentBoxNum = (currentBoxNum === num) ? null : num;
    document.querySelectorAll('.box-num-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.num) === currentBoxNum);
    });
}

function addEditInvoiceDrink(existingDrink = null) {
    const container = document.getElementById('editInvoiceDrinks');
    const drinkNum = container.children.length + 1;
    const item = document.createElement('div');
    item.className = 'drink-item';
    item.innerHTML = `
        <div class="drink-item-header">
            <div class="drink-item-label">ãƒ‰ãƒªãƒ³ã‚¯ ${drinkNum}</div>
            <button class="btn btn-secondary" onclick="this.closest('.drink-item').remove();calculateEditInvoice();event.stopPropagation();">Ã—</button>
        </div>
        <div class="drink-item-row">
            <div class="form-group" style="flex:2;">
                <label class="form-label">èª°ãŒé£²ã‚€</label>
                <select class="form-control drink-person-type" onchange="updatePersonOptions(this);updateDrinkOptions(this);updateDrinkLabel(this);calculateEditInvoice()">
                    <option value="">é¸æŠ</option>
                    <option value="cast" ${existingDrink&&existingDrink.castId?'selected':''}>ã‚­ãƒ£ã‚¹ãƒˆ</option>
                    <option value="customer" ${existingDrink&&existingDrink.customerId?'selected':''}>ãŠå®¢æ§˜</option>
                </select>
            </div>
            <div class="form-group" style="flex:2;">
                <label class="form-label">åå‰</label>
                <select class="form-control drink-person" onchange="updateDrinkLabel(this);calculateEditInvoice()">
                    <option value="">é¸æŠ</option>
                </select>
            </div>
        </div>
        <div class="drink-item-row">
            <div class="form-group" style="flex:3;">
                <label class="form-label">ç¨®é¡</label>
                <select class="form-control drink-type" onchange="updateDrinkLabel(this);calculateEditInvoice()">
                    <option value="">é¸æŠ</option>
                </select>
            </div>
            <div class="form-group" style="flex:1.2;">
                <label class="form-label">æ¯æ•°</label>
                <div class="counter-wrap drink-counter">
                    <button class="counter-btn minus" onclick="changeDrinkCount(this,-1)">ï¼</button>
                    <div class="counter-val drink-count-val">1</div>
                    <button class="counter-btn" onclick="changeDrinkCount(this,1)">ï¼‹</button>
                </div>
                <input type="hidden" class="drink-count" value="${existingDrink?existingDrink.count:1}">
            </div>
        </div>
    `;
    container.appendChild(item);
    if (existingDrink) {
        const pts = item.querySelector('.drink-person-type');
        updatePersonOptions(pts);
        const ps = item.querySelector('.drink-person');
        ps.value = existingDrink.castId || existingDrink.customerId || '';
        updateDrinkOptions(pts);
        const ds = item.querySelector('.drink-type');
        ds.value = existingDrink.drinkId || '';
        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤ºã‚’æ—¢å­˜ã®æ¯æ•°ã§åˆæœŸåŒ–
        const countVal = existingDrink.count || 1;
        item.querySelector('.drink-count').value = countVal;
        item.querySelector('.drink-count-val').textContent = countVal;
    }
    calculateEditInvoice();
}

function updateDrinkOptions(personTypeSelect) {
    const item = personTypeSelect.closest('.drink-item');
    const drinkSelect = item.querySelector('.drink-type');
    const personType = personTypeSelect.value;
    drinkSelect.innerHTML = '<option value="">é¸æŠ</option>';
    if (!personType) return;
    const groups = ['ã‚«ã‚¯ãƒ†ãƒ«','ã‚·ãƒ§ãƒƒãƒˆ','ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³','ãƒ“ãƒ¼ãƒ«','ãã®ä»–'];
    groups.forEach(g => {
        const drinks = appData.drinkSettings.filter(d => d.type === g && (d.target === 'both' || d.target === personType));
        if (!drinks.length) return;
        const og = document.createElement('optgroup');
        og.label = g;
        drinks.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.name} ${d.shotType==='ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼'?'Â¥1,000(10æœ¬Â¥800/æœ¬)':`Â¥${d.price.toLocaleString()}`}`;
            og.appendChild(opt);
        });
        drinkSelect.appendChild(og);
    });
}

function updatePersonOptions(personTypeSelect) {
    const item = personTypeSelect.closest('.drink-item');
    const ps = item.querySelector('.drink-person');
    const pType = personTypeSelect.value;
    ps.innerHTML = '<option value="">é¸æŠ</option>';
    if (pType === 'cast') {
        appData.casts.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; ps.appendChild(o); });
    } else if (pType === 'customer') {
        appData.customers.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; ps.appendChild(o); });
    }
}

function updateDrinkLabel(el) {
    const item = el.closest('.drink-item');
    const pts = item.querySelector('.drink-person-type');
    const ps = item.querySelector('.drink-person');
    const ds = item.querySelector('.drink-type');
    const cnt = item.querySelector('.drink-count');
    const lbl = item.querySelector('.drink-item-label');
    const pId = ps.value, dId = ds.value;
    if (pId && dId) {
        let pName = '';
        if (pts.value === 'cast') { const c = appData.casts.find(x=>x.id===pId); pName = c?.name||''; }
        else { const c = appData.customers.find(x=>x.id===pId); pName = c?.name||''; }
        const d = appData.drinkSettings.find(x=>x.id===dId);
        lbl.textContent = `${pName} - ${d?.name||''} Ã— ${cnt.value}${d?.shotType==='ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼'?'æœ¬':'æ¯'}`;
    } else {
        const n = Array.from(item.parentElement.children).indexOf(item) + 1;
        lbl.textContent = `ãƒ‰ãƒªãƒ³ã‚¯ ${n}`;
    }
}

// â”€â”€ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function changeKaraoke(delta) {
    const hidden = document.getElementById('editInvoiceKaraoke');
    const disp = document.getElementById('editInvoiceKaraokeVal');
    let val = parseInt(hidden.value) || 0;
    val = Math.max(0, val + delta);
    hidden.value = val;
    disp.textContent = val;
    calculateEditInvoice();
}

function changeDrinkCount(btn, delta) {
    const item = btn.closest('.drink-item');
    const hidden = item.querySelector('.drink-count');
    const disp = item.querySelector('.drink-count-val');
    let val = parseInt(hidden.value) || 1;
    val = Math.max(1, val + delta);
    hidden.value = val;
    disp.textContent = val;
    updateDrinkLabel(btn);
    calculateEditInvoice();
}

function roundUpTo50(n) { return Math.ceil(n / 50) * 50; }

function calculateEditInvoice() {
    const setData = document.getElementById('editInvoiceSet').value.split('-');
    const setPrice = parseInt(setData[0]) || 0;
    const hasBottle = setData[1] === 'true';
    const people = parseInt(document.getElementById('editInvoicePeople').value) || 1;
    const seatPrice = parseInt(document.getElementById('editInvoiceSeat').value) || 0;
    const ext = parseInt(document.getElementById('editInvoiceExtension').value) || 0;
    const totalSet = setPrice * people + seatPrice;
    let extPrice = 0;
    if (!hasBottle && ext > 0) extPrice = roundUpTo50((totalSet / 2) * ext);
    const karaoke = parseInt(document.getElementById('editInvoiceKaraoke').value) || 0;
    const karaokePrice = karaoke * 200;

    const kleinerByPerson = {}, processed = {};
    document.querySelectorAll('#editInvoiceDrinks .drink-item').forEach(item => {
        const dId = item.querySelector('.drink-type').value;
        const cnt = parseInt(item.querySelector('.drink-count').value) || 0;
        const pType = item.querySelector('.drink-person-type').value;
        const pId = item.querySelector('.drink-person').value;
        if (!dId || !pId) return;
        const d = appData.drinkSettings.find(x => x.id === dId);
        if (d && d.shotType === 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼') {
            const key = `${pType}-${pId}`;
            kleinerByPerson[key] = (kleinerByPerson[key] || 0) + cnt;
        }
    });

    let drinksTotal = 0;
    document.querySelectorAll('#editInvoiceDrinks .drink-item').forEach(item => {
        const dId = item.querySelector('.drink-type').value;
        const cnt = parseInt(item.querySelector('.drink-count').value) || 0;
        const pType = item.querySelector('.drink-person-type').value;
        const pId = item.querySelector('.drink-person').value;
        if (!dId || !pId) return;
        const d = appData.drinkSettings.find(x => x.id === dId);
        if (!d) return;
        if (d.shotType === 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼') {
            const key = `${pType}-${pId}`;
            if (!processed[key]) {
                const tot = kleinerByPerson[key];
                drinksTotal += Math.floor(tot / 10) * 10 * 800 + (tot % 10) * 1000;
                processed[key] = true;
            }
        } else {
            drinksTotal += d.price * cnt;
        }
    });

    const total = roundUpTo50(totalSet + extPrice + karaokePrice + drinksTotal);
    document.getElementById('editInvoiceTotal').textContent = `Â¥${total.toLocaleString()}`;
    document.getElementById('extensionGroup').style.display = hasBottle ? 'none' : 'block';
    if (hasBottle) document.getElementById('editInvoiceExtension').value = '0';
}

async function saveEditInvoice() {
    const invoiceId = currentEditingInvoiceId;
    let inv = appData.activeInvoices.find(i => i.id === invoiceId);
    let isCompleted = false;
    if (!inv) { inv = appData.invoices.find(i => i.id === invoiceId); isCompleted = true; }
    if (!inv) return;

    const setData = document.getElementById('editInvoiceSet').value.split('-');
    inv.setPrice = parseInt(setData[0]);
    inv.hasBottle = setData[1] === 'true';
    inv.people = parseInt(document.getElementById('editInvoicePeople').value) || 1;
    inv.customerId = document.getElementById('editInvoiceCustomer').value;
    inv.seatPrice = parseInt(document.getElementById('editInvoiceSeat').value);
    inv.boxNum = currentBoxNum;
    inv.extension = parseInt(document.getElementById('editInvoiceExtension').value);
    inv.karaoke = parseInt(document.getElementById('editInvoiceKaraoke').value);
    inv.drinks = collectDrinks();
    inv.total = parseInt(document.getElementById('editInvoiceTotal').textContent.replace(/[^0-9]/g, ''));

    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('invoiceModal');
    if (isCompleted) renderCompletedInvoices();
    else renderActiveInvoices();
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
}

async function completeInvoice() {
    const invoiceId = currentEditingInvoiceId;
    const idx = appData.activeInvoices.findIndex(i => i.id === invoiceId);
    if (idx === -1) { alert('ã“ã®ä¼ç¥¨ã¯æ—¢ã«ç¢ºå®šæ¸ˆã¿ã§ã™'); return; }
    if (!document.getElementById('editInvoiceCustomer').value) { alert('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    const inv = appData.activeInvoices[idx];
    const setData = document.getElementById('editInvoiceSet').value.split('-');
    inv.setPrice = parseInt(setData[0]);
    inv.hasBottle = setData[1] === 'true';
    inv.people = parseInt(document.getElementById('editInvoicePeople').value) || 1;
    inv.customerId = document.getElementById('editInvoiceCustomer').value;
    inv.seatPrice = parseInt(document.getElementById('editInvoiceSeat').value);
    inv.boxNum = currentBoxNum;
    inv.extension = parseInt(document.getElementById('editInvoiceExtension').value);
    inv.karaoke = parseInt(document.getElementById('editInvoiceKaraoke').value);
    inv.drinks = collectDrinks();
    inv.total = parseInt(document.getElementById('editInvoiceTotal').textContent.replace(/[^0-9]/g, ''));
    inv.status = 'completed';
    inv.completedAt = new Date().toISOString();

    appData.activeInvoices.splice(idx, 1);
    appData.invoices.push(inv);
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('invoiceModal');
    renderActiveInvoices();
    renderCompletedInvoices();
    if (confirm('ä¼ç¥¨ã‚’ç¢ºå®šã—ã¾ã—ãŸï¼\nãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã™ã‹ï¼Ÿ')) {
        printReceipt(inv.id);
    }
}

function collectDrinks() {
    const drinks = [];
    document.querySelectorAll('#editInvoiceDrinks .drink-item').forEach(item => {
        const pType = item.querySelector('.drink-person-type').value;
        const pId = item.querySelector('.drink-person').value;
        const dId = item.querySelector('.drink-type').value;
        const cnt = parseInt(item.querySelector('.drink-count').value);
        if (!pId || !dId) return;
        const d = appData.drinkSettings.find(x => x.id === dId);
        if (!d) return;
        const rec = { drinkId: d.id, name: d.name, type: d.type, price: d.price, count: cnt };
        if (d.shotType) rec.shotType = d.shotType;
        if (pType === 'cast') rec.castId = pId;
        else rec.customerId = pId;
        drinks.push(rec);
    });
    return drinks;
}

async function deleteInvoice() {
    if (!confirm('ã“ã®ä¼ç¥¨ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    const id = currentEditingInvoiceId;
    const ai = appData.activeInvoices.findIndex(i => i.id === id);
    if (ai !== -1) {
        appData.activeInvoices.splice(ai, 1);
        showLoading(true); await saveData(); showLoading(false);
        closeModal('invoiceModal'); renderActiveInvoices(); alert('å‰Šé™¤ã—ã¾ã—ãŸ'); return;
    }
    const ci = appData.invoices.findIndex(i => i.id === id);
    if (ci !== -1) {
        appData.invoices.splice(ci, 1);
        showLoading(true); await saveData(); showLoading(false);
        closeModal('invoiceModal'); renderCompletedInvoices(); alert('å‰Šé™¤ã—ã¾ã—ãŸ');
    }
}

function renderActiveInvoices() {
    const c = document.getElementById('activeInvoices');
    if (!appData.activeInvoices.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ§¾</div><div>é€²è¡Œä¸­ã®ä¼ç¥¨ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>'; return;
    }
    c.innerHTML = appData.activeInvoices.map(inv => {
        const cu = appData.customers.find(c => c.id === inv.customerId);
        const time = new Date(inv.createdAt).toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'});
        const dc = inv.drinks.reduce((s,d)=>s+d.count,0);
        const seatLabel = inv.seatPrice > 0 ? ` / BOX${inv.boxNum ? ' #'+inv.boxNum : ''}` : ' / ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼';
        return `<div class="list-item active-invoice" onclick="editInvoice('${inv.id}')">
            <div class="list-item-header">
                <div class="list-item-title">${cu?.name||'æœªè¨­å®š'} <span class="badge badge-warning" style="font-size:11px;">é€²è¡Œä¸­</span></div>
                <span class="badge badge-primary">Â¥${(inv.total||0).toLocaleString()}</span>
            </div>
            <div class="list-item-meta">${time} é–‹å§‹ / ${inv.people||1}å${seatLabel} / ãƒ‰ãƒªãƒ³ã‚¯${dc}æ¯</div>
        </div>`;
    }).join('');
}

function renderCompletedInvoices() {
    const c = document.getElementById('completedInvoices');
    const today = new Date().toISOString().split('T')[0];
    const list = appData.invoices.filter(i => i.completedAt && i.completedAt.split('T')[0] === today);
    if (!list.length) {
        c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœ…</div><div>æœ¬æ—¥ã®ç¢ºå®šä¼ç¥¨ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>'; return;
    }
    c.innerHTML = list.map(inv => {
        const cu = appData.customers.find(c => c.id === inv.customerId);
        const time = new Date(inv.completedAt).toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'});
        const seatLabel = inv.seatPrice > 0 ? ` / BOX${inv.boxNum ? ' #'+inv.boxNum : ''}` : ' / ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼';
        return `<div class="list-item" onclick="editCompletedInvoice('${inv.id}')">
            <div class="list-item-header">
                <div class="list-item-title">${cu?.name||'ä¸æ˜'}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="badge badge-success">Â¥${inv.total.toLocaleString()}</span>
                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="printReceipt('${inv.id}');event.stopPropagation();">ğŸ–¨ï¸</button>
                </div>
            </div>
            <div class="list-item-meta">${time} / ${inv.people||1}å${seatLabel} / ãƒ‰ãƒªãƒ³ã‚¯${inv.drinks.reduce((s,d)=>s+d.count,0)}æ¯</div>
        </div>`;
    }).join('');
}

// â”€â”€ çµ¦æ–™è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSalarySection() {
    renderCastSelects();
    buildTimeSelects();
}

function buildTimeSelects() {
    const startSel = document.getElementById('quickWorkStart');
    const endSel = document.getElementById('quickWorkEnd');
    if (!startSel) return;

    // é€šå¸¸æ™‚åˆ»ï¼ˆ00:00ã€œ23:30ï¼‰
    const slots = [];
    for (let h = 0; h < 24; h++) {
        for (let m of [0, 30]) {
            const hh = String(h).padStart(2, '0');
            const mm = String(m).padStart(2, '0');
            slots.push({ label: hh + ':' + mm, value: hh + ':' + mm });
        }
    }
    // ç¿Œæ™‚åˆ»ï¼ˆç¿Œ00:00ã€œç¿Œ06:30ï¼‰â†’ å€¤ã¯åŒã˜æ™‚åˆ»æ–‡å­—åˆ—ã€saveæ™‚ã«+1æ—¥ã§å¯¾å¿œ
    const lateSlots = [];
    for (let h = 0; h <= 6; h++) {
        for (let m of [0, 30]) {
            const hh = String(h).padStart(2, '0');
            const mm = String(m).padStart(2, '0');
            lateSlots.push({ label: 'ç¿Œ' + hh + ':' + mm, value: hh + ':' + mm });
        }
    }

    function fillSelect(sel, includeLate) {
        sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        slots.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.value; opt.textContent = s.label;
            sel.appendChild(opt);
        });
        if (includeLate) {
            const grp = document.createElement('optgroup');
            grp.label = 'â”€â”€ ç¿Œæ—¥ â”€â”€';
            lateSlots.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.value; opt.textContent = s.label;
                grp.appendChild(opt);
            });
            sel.appendChild(grp);
        }
    }

    fillSelect(startSel, false);
    fillSelect(endSel, true);
}

// â”€â”€ å‹¤å‹™æ™‚é–“ ç·¨é›†ãƒ»å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditWorkTime(workId) {
    const w = appData.workTimes.find(x => x.id === workId);
    if (!w) return;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ§‹ç¯‰ï¼ˆæœªæ§‹ç¯‰ãªã‚‰ï¼‰
    buildEditWorkTimeSelects();

    document.getElementById('editWorkTimeId').value = w.id;
    document.getElementById('editWorkDate').value = w.date;
    document.getElementById('editWorkStart').value = w.start;
    document.getElementById('editWorkEnd').value = w.end;
    document.getElementById('editWorkDohan').value = w.dohan || 0;
    document.getElementById('editWorkTransport').value =
        (w.transportOverride !== undefined) ? w.transportOverride : -1;
    openModal('editWorkTimeModal');
}

function buildEditWorkTimeSelects() {
    const startSel = document.getElementById('editWorkStart');
    if (startSel.options.length > 1) return; // åˆå›ã®ã¿

    const slots = [];
    for (let h = 0; h < 24; h++) {
        for (let m of [0, 30]) {
            const hh = String(h).padStart(2,'0');
            const mm = String(m).padStart(2,'0');
            slots.push(hh + ':' + mm);
        }
    }
    const lateSlots = [];
    for (let h = 0; h <= 6; h++) {
        for (let m of [0, 30]) {
            const hh = String(h).padStart(2,'0');
            const mm = String(m).padStart(2,'0');
            lateSlots.push({ label: 'ç¿Œ' + hh + ':' + mm, value: hh + ':' + mm });
        }
    }

    function fillSel(sel, includeLate) {
        sel.innerHTML = '<option value="">é¸æŠ</option>';
        slots.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            sel.appendChild(opt);
        });
        if (includeLate) {
            const grp = document.createElement('optgroup');
            grp.label = 'â”€â”€ ç¿Œæ—¥ â”€â”€';
            lateSlots.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.value; opt.textContent = s.label;
                grp.appendChild(opt);
            });
            sel.appendChild(grp);
        }
    }
    fillSel(startSel, false);
    fillSel(document.getElementById('editWorkEnd'), true);
}

async function saveEditWorkTime() {
    const id = document.getElementById('editWorkTimeId').value;
    const date = document.getElementById('editWorkDate').value;
    const start = document.getElementById('editWorkStart').value;
    const end = document.getElementById('editWorkEnd').value;
    const dohan = parseInt(document.getElementById('editWorkDohan').value);
    const transportOverride = parseInt(document.getElementById('editWorkTransport').value);
    if (!date || !start || !end) { alert('æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const idx = appData.workTimes.findIndex(x => x.id === id);
    if (idx === -1) return;

    let st = new Date(`${date}T${start}`), et = new Date(`${date}T${end}`);
    if (et <= st) et.setDate(et.getDate() + 1);
    const hrs = Math.round((et - st) / (1000*60*60) * 2) / 2;

    appData.workTimes[idx] = { ...appData.workTimes[idx], date, start, end, hours: hrs, dohan, transportOverride };
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editWorkTimeModal');
    loadCastSalaryData();
    alert('æ›´æ–°ã—ã¾ã—ãŸï¼');
}

async function deleteWorkTime() {
    const id = document.getElementById('editWorkTimeId').value;
    const w = appData.workTimes.find(x => x.id === id);
    if (!confirm(`${new Date(w.date).toLocaleDateString('ja-JP')} ã®å‹¤å‹™è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    appData.workTimes = appData.workTimes.filter(x => x.id !== id);
    showLoading(true);
    await saveData();
    showLoading(false);
    closeModal('editWorkTimeModal');
    loadCastSalaryData();
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
}

async function saveQuickWorkTime() {
    const castId = document.getElementById('salaryCast').value;
    const date = document.getElementById('quickWorkDate').value;
    const start = document.getElementById('quickWorkStart').value;
    const end = document.getElementById('quickWorkEnd').value;
    const dohan = parseInt(document.getElementById('quickWorkDohan').value);
    const transportOverride = parseInt(document.getElementById('quickWorkTransport').value);
    if (!castId || !date || !start || !end) { alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    let st = new Date(`${date}T${start}`), et = new Date(`${date}T${end}`);
    if (et <= st) et.setDate(et.getDate() + 1);
    const hrs = Math.round((et - st) / (1000*60*60) * 2) / 2;
    showLoading(true);
    // transportOverride=-1 ã¯ã‚­ãƒ£ã‚¹ãƒˆè¨­å®šã®é€è¿ä»£ã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ãã®æ—¥ã®å€‹åˆ¥æŒ‡å®š
    appData.workTimes.push({ id: Date.now().toString(), castId, date, start, end, hours: hrs, dohan, transportOverride });
    await saveData();
    showLoading(false);
    document.getElementById('quickWorkStart').value = '';
    document.getElementById('quickWorkEnd').value = '';
    document.getElementById('quickWorkDohan').value = '0';
    document.getElementById('quickWorkTransport').value = '-1';
    loadCastSalaryData();
    alert('å‹¤å‹™æ™‚é–“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
}

function loadCastSalaryData() {
    const castId = document.getElementById('salaryCast').value;
    const period = document.getElementById('salaryPeriod').value;
    const c = document.getElementById('salaryDetails');
    const wti = document.getElementById('workTimeInput');
    if (!castId) { c.innerHTML = ''; wti.style.display = 'none'; return; }
    wti.style.display = 'block';
    buildTimeSelects();
    document.getElementById('quickWorkDate').value = new Date().toISOString().split('T')[0];
    const cast = appData.casts.find(x => x.id === castId);
    if (!cast) return;

    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const filterDate = period === 'today'
        ? d => d.split('T')[0] === today
        : d => { const dt = new Date(d); return dt.getFullYear()===now.getFullYear()&&dt.getMonth()===now.getMonth(); };

    const wts = appData.workTimes.filter(w => w.castId === castId && filterDate(w.date));
    const totalHours = wts.reduce((s,w) => s+w.hours, 0);
    const dohanCnt = wts.filter(w => w.dohan===1).length;
    const hourlyPay = totalHours * cast.hourly;
    const dohanPay = dohanCnt * cast.dohanBack;
    const transportPay = wts.reduce((s, w) => {
        const t = (w.transportOverride !== undefined && w.transportOverride >= 0)
            ? w.transportOverride
            : cast.transport;
        return s + t;
    }, 0);

    const invs = appData.invoices.filter(i => filterDate(i.completedAt || i.createdAt));
    let drinkBacks = {}, drinkBackTotal = 0;
    invs.forEach(inv => inv.drinks.forEach(d => {
        if (d.castId !== castId) return;
        if (!drinkBacks[d.type]) drinkBacks[d.type] = { count:0, amount:0 };
        drinkBacks[d.type].count += d.count;
        let back = d.type === 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³'
            ? d.price * d.count * (cast.champagneBackRate / 100)
            : d.count * (cast.drinkBacks[d.type] || 0);
        drinkBacks[d.type].amount += back;
        drinkBackTotal += back;
    }));

    const total = hourlyPay + drinkBackTotal + dohanPay + transportPay;
    c.innerHTML = `
        <div class="summary-section">
            <div class="stat-grid">
                <div class="stat-card"><div class="stat-label">å‹¤å‹™æ™‚é–“</div><div class="stat-value">${totalHours}h</div></div>
                <div class="stat-card"><div class="stat-label">æ™‚çµ¦åˆ†</div><div class="stat-value">Â¥${hourlyPay.toLocaleString()}</div></div>
                <div class="stat-card"><div class="stat-label">ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯</div><div class="stat-value">Â¥${drinkBackTotal.toLocaleString()}</div></div>
                <div class="stat-card"><div class="stat-label">åŒä¼´ãƒãƒƒã‚¯</div><div class="stat-value">Â¥${dohanPay.toLocaleString()}</div></div>
                <div class="stat-card"><div class="stat-label">é€è¿ä»£</div><div class="stat-value">Â¥${transportPay.toLocaleString()}</div></div>
            </div>
            <div class="total-display" style="margin-top:20px;">
                <div class="total-label">åˆè¨ˆçµ¦æ–™</div>
                <div class="total-amount">Â¥${total.toLocaleString()}</div>
            </div>
        </div>
        ${Object.keys(drinkBacks).length ? `<div style="margin-top:20px;"><h4 style="margin-bottom:10px;color:var(--primary);">ãƒ‰ãƒªãƒ³ã‚¯è©³ç´°</h4>
            ${Object.entries(drinkBacks).map(([type,data]) => {
                const bi = type==='ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³' ? `${cast.champagneBackRate}% ãƒãƒƒã‚¯` : `Â¥${cast.drinkBacks[type]}/æ¯`;
                return `<div class="list-item"><div class="list-item-header"><div class="list-item-title">${type}</div><span class="badge badge-success">Â¥${Math.round(data.amount).toLocaleString()}</span></div><div class="list-item-meta">${data.count}æ¯ Ã— ${bi}</div></div>`;
            }).join('')}</div>` : ''}
        ${wts.length ? `<div style="margin-top:20px;"><h4 style="margin-bottom:10px;color:var(--primary);">å‹¤å‹™å±¥æ­´</h4>
            ${wts.map(w => {
                const tAmt = (w.transportOverride !== undefined && w.transportOverride >= 0) ? w.transportOverride : cast.transport;
                const tText = tAmt > 0 ? ` / é€è¿ Â¥${tAmt.toLocaleString()}` : '';
                return `<div class="list-item" style="cursor:pointer;" onclick="openEditWorkTime('${w.id}')">
                    <div class="list-item-header">
                        <div class="list-item-title">${new Date(w.date).toLocaleDateString('ja-JP')}</div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="badge badge-primary">${w.hours}æ™‚é–“</span>
                            <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="openEditWorkTime('${w.id}');event.stopPropagation();">ç·¨é›†</button>
                        </div>
                    </div>
                    <div class="list-item-meta">${w.start} ï½ ${w.end}${w.dohan?' / åŒä¼´ã‚ã‚Š':''}${tText}</div>
                </div>`;
            }).join('')}</div>` : ''}
    `;
}

// â”€â”€ å£²ä¸Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ å£²ä¸ŠæœŸé–“åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSalesPeriodChange() {
    const period = document.getElementById('salesPeriod').value;
    const monthRow = document.getElementById('salesMonthRow');
    const dayRow = document.getElementById('salesDayRow');

    if (period === 'monthly') {
        monthRow.style.display = 'block';
        buildSalesMonthSelect();
    } else {
        monthRow.style.display = 'none';
        dayRow.style.display = 'none';
    }
    loadSalesData();
}

function buildSalesMonthSelect() {
    const sel = document.getElementById('salesMonth');
    // ä¼ç¥¨ã‹ã‚‰å­˜åœ¨ã™ã‚‹å¹´æœˆã‚’åé›†
    const monthSet = new Set();
    appData.invoices.forEach(i => {
        const d = new Date(i.completedAt || i.createdAt);
        monthSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
    });
    const months = [...monthSet].sort().reverse();
    const now = new Date();
    const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    sel.innerHTML = months.length
        ? months.map(m => {
            const [y, mo] = m.split('-');
            return `<option value="${m}" ${m===thisMonth?'selected':''}>${y}å¹´${parseInt(mo)}æœˆ</option>`;
          }).join('')
        : '<option value="">ãƒ‡ãƒ¼ã‚¿ãªã—</option>';
    onSalesMonthChange();
}

function onSalesMonthChange() {
    const month = document.getElementById('salesMonth').value;
    const dayRow = document.getElementById('salesDayRow');
    if (!month) { dayRow.style.display = 'none'; return; }

    // ãã®æœˆã®å–¶æ¥­æ—¥ã‚’åé›†
    const [y, mo] = month.split('-').map(Number);
    const daySet = new Set();
    appData.invoices.forEach(i => {
        const d = new Date(i.completedAt || i.createdAt);
        if (d.getFullYear() === y && d.getMonth()+1 === mo) {
            daySet.add(d.toISOString().split('T')[0]);
        }
    });
    const days = [...daySet].sort().reverse();
    const sel = document.getElementById('salesDay');
    sel.innerHTML = '<option value="">â”€â”€ æœˆå…¨ä½“ã®é›†è¨ˆã‚’è¡¨ç¤º</option>'
        + days.map(d => {
            const dt = new Date(d);
            return `<option value="${d}">${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dt.getDay()]}ï¼‰</option>`;
          }).join('');
    dayRow.style.display = 'block';
    loadSalesData();
}

function loadSalesData() {
    const period = document.getElementById('salesPeriod').value;
    const type = document.getElementById('salesType').value;
    const now = new Date();
    const today = now.toISOString().split('T')[0];

    let filterDate;
    let periodLabel = '';

    if (period === 'today') {
        filterDate = d => d.split('T')[0] === today;
        periodLabel = 'æœ¬æ—¥';
    } else if (period === 'month') {
        filterDate = d => {
            const dt = new Date(d);
            return dt.getFullYear()===now.getFullYear() && dt.getMonth()===now.getMonth();
        };
        periodLabel = `${now.getMonth()+1}æœˆ`;
    } else if (period === 'monthly') {
        const month = document.getElementById('salesMonth')?.value;
        const selectedDay = document.getElementById('salesDay')?.value;
        if (!month) { filterDate = () => false; }
        else if (selectedDay) {
            // ç‰¹å®šã®æ—¥
            filterDate = d => d.split('T')[0] === selectedDay;
            const dt = new Date(selectedDay);
            periodLabel = `${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥`;
        } else {
            // æœˆå…¨ä½“
            const [y, mo] = month.split('-').map(Number);
            filterDate = d => {
                const dt = new Date(d);
                return dt.getFullYear()===y && dt.getMonth()+1===mo;
            };
            periodLabel = `${month.split('-')[0]}å¹´${parseInt(month.split('-')[1])}æœˆ`;
        }
    }

    const invs = appData.invoices.filter(i => filterDate(i.completedAt || i.createdAt));
    if (type === 'total') renderTotalSales(invs, periodLabel);
    else if (type === 'customer') renderCustomerSales(invs);
    else if (type === 'cast') renderCastSales(invs);
    else if (type === 'cross') renderCrossTable(invs);
}

function renderTotalSales(invs, periodLabel) {
    const total = invs.reduce((s,i)=>s+i.total,0);
    const dc = invs.reduce((s,i)=>s+i.drinks.reduce((ss,d)=>ss+d.count,0),0);
    const cuSet = new Set(invs.map(i=>i.customerId)).size;
    const labelHtml = periodLabel ? `<div style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">ğŸ“… ${periodLabel}ã®å£²ä¸Š</div>` : '';
    document.getElementById('salesSummary').innerHTML = labelHtml + `<div class="stat-grid">
        <div class="stat-card"><div class="stat-label">ç·å£²ä¸Š</div><div class="stat-value large">Â¥${total.toLocaleString()}</div></div>
        <div class="stat-card"><div class="stat-label">ä¼ç¥¨æ•°</div><div class="stat-value">${invs.length}ä»¶</div></div>
        <div class="stat-card"><div class="stat-label">æ¥åº—å®¢æ•°</div><div class="stat-value">${cuSet}å</div></div>
        <div class="stat-card"><div class="stat-label">ãƒ‰ãƒªãƒ³ã‚¯æ•°</div><div class="stat-value">${dc}æ¯</div></div>
    </div>`;
    document.getElementById('salesDetails').innerHTML = '';
}

function renderCustomerSales(invs) {
    const sales = {};
    invs.forEach(i => {
        if (!sales[i.customerId]) sales[i.customerId] = { total:0, count:0, drinks:0 };
        sales[i.customerId].total += i.total;
        sales[i.customerId].count++;
        sales[i.customerId].drinks += i.drinks.reduce((s,d)=>s+d.count,0);
    });
    const sorted = Object.entries(sales).sort((a,b)=>b[1].total-a[1].total);
    const grandTotal = invs.reduce((s,i)=>s+i.total,0);
    document.getElementById('salesSummary').innerHTML = `<div class="stat-card"><div class="stat-label">ç·å£²ä¸Š</div><div class="stat-value large">Â¥${grandTotal.toLocaleString()}</div></div>`;
    document.getElementById('salesDetails').innerHTML = sorted.length ? sorted.map(([cid,d]) => {
        const cu = appData.customers.find(x=>x.id===cid);
        return `<div class="list-item"><div class="list-item-header"><div class="list-item-title">${cu?.name||'ä¸æ˜'}</div><span class="badge badge-primary">Â¥${d.total.toLocaleString()}</span></div><div class="list-item-meta">${d.count}å›æ¥åº— / ãƒ‰ãƒªãƒ³ã‚¯${d.drinks}æ¯</div></div>`;
    }).join('') : '<div class="empty-state"><div>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
}

function renderCastSales(invs) {
    const castTotals = {};
    invs.forEach(inv => {
        const castIds = [...new Set(inv.drinks.filter(d=>d.castId).map(d=>d.castId))];
        if (!castIds.length) return;
        castIds.forEach(cid => {
            if (!castTotals[cid]) castTotals[cid] = { drinkTotal:0, drinkCount:0, invSet: new Set() };
            inv.drinks.filter(d=>d.castId===cid).forEach(d => {
                castTotals[cid].drinkCount += d.count;
                castTotals[cid].drinkTotal += d.price * d.count;
            });
            castTotals[cid].invSet.add(inv.id);
        });
    });
    const grandTotal = invs.reduce((s,i)=>s+i.total,0);
    document.getElementById('salesSummary').innerHTML = `<div class="stat-card"><div class="stat-label">ç·å£²ä¸Š</div><div class="stat-value large">Â¥${grandTotal.toLocaleString()}</div></div>`;
    const sorted = Object.entries(castTotals).sort((a,b)=>b[1].drinkTotal-a[1].drinkTotal);
    document.getElementById('salesDetails').innerHTML = sorted.length ? sorted.map(([cid,d]) => {
        const cast = appData.casts.find(x=>x.id===cid);
        return `<div class="list-item"><div class="list-item-header"><div class="list-item-title">${cast?.name||'ä¸æ˜'}</div><span class="badge badge-primary">ãƒ‰ãƒªãƒ³ã‚¯ Â¥${d.drinkTotal.toLocaleString()}</span></div><div class="list-item-meta">é–¢é€£ä¼ç¥¨ ${d.invSet.size}ä»¶ / ${d.drinkCount}æ¯</div></div>`;
    }).join('') : '<div class="empty-state"><div>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
}

function renderCrossTable(invs) {
    document.getElementById('salesSummary').innerHTML = `<div class="stat-card"><div class="stat-label">ç·å£²ä¸Š</div><div class="stat-value large">Â¥${invs.reduce((s,i)=>s+i.total,0).toLocaleString()}</div></div>`;
    if (!invs.length) {
        document.getElementById('salesDetails').innerHTML = '<div class="empty-state"><div>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>'; return;
    }

    // ã‚­ãƒ£ã‚¹ãƒˆã¸ã®ãƒ‰ãƒªãƒ³ã‚¯ä»£ã®ã¿ã§é›†è¨ˆï¼ˆã‚»ãƒƒãƒˆæ–™é‡‘ã¯å«ã¾ãªã„ï¼‰
    const crossData = {};
    invs.forEach(inv => {
        const cuId = inv.customerId;
        if (!cuId) return;
        if (!crossData[cuId]) crossData[cuId] = {};
        inv.drinks.forEach(d => {
            if (!d.castId) return;
            const amt = d.price * d.count;
            crossData[cuId][d.castId] = (crossData[cuId][d.castId] || 0) + amt;
        });
    });

    // ç™»å ´ã—ãŸã‚­ãƒ£ã‚¹ãƒˆIDã‚’åé›†
    const castIdSet = new Set();
    Object.values(crossData).forEach(row => Object.keys(row).forEach(k => castIdSet.add(k)));
    const castIds = [...castIdSet];

    // å£²ä¸Šé™é †ã§é¡§å®¢ã‚’ä¸¦ã¹ã‚‹
    const customerIds = Object.keys(crossData).sort((a,b) => {
        const ta = Object.values(crossData[a]).reduce((s,v)=>s+v,0);
        const tb = Object.values(crossData[b]).reduce((s,v)=>s+v,0);
        return tb - ta;
    });

    if (!castIds.length || !customerIds.length) {
        document.getElementById('salesDetails').innerHTML = '<div class="empty-state"><div>ã‚­ãƒ£ã‚¹ãƒˆã¸ã®ãƒ‰ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>'; return;
    }

    const castNames = castIds.map(id => appData.casts.find(c=>c.id===id)?.name || 'ä¸æ˜');
    let html = `<div style="margin-top:10px;font-size:12px;color:var(--text-dim);margin-bottom:8px;">â€» ã‚­ãƒ£ã‚¹ãƒˆã¸ã®ãƒ‰ãƒªãƒ³ã‚¯ä»£ã®ã¿é›†è¨ˆï¼ˆã‚»ãƒƒãƒˆæ–™é‡‘é™¤ãï¼‰</div>
    <div class="cross-table-wrap"><table class="cross-table">
        <thead><tr><th>é¡§å®¢</th>${castNames.map(n=>`<th>${n}</th>`).join('')}
        <th style="color:var(--warning);">åˆè¨ˆ</th></tr></thead><tbody>`;

    customerIds.forEach(cuId => {
        const cu = appData.customers.find(c=>c.id===cuId);
        const row = crossData[cuId];
        const rowTotal = Object.values(row).reduce((s,v)=>s+v,0);
        if (rowTotal === 0) return;
        html += `<tr><td>${cu?.name||'ä¸æ˜'}</td>`;
        castIds.forEach(cid => {
            const v = row[cid] || 0;
            html += `<td class="${v===0?'zero':''}">${v===0?'-':'Â¥'+v.toLocaleString()}</td>`;
        });
        html += `<td style="color:var(--warning);font-weight:700;">Â¥${rowTotal.toLocaleString()}</td></tr>`;
    });

    // åˆè¨ˆè¡Œ
    html += `<tr class="total-row"><td>åˆè¨ˆ</td>`;
    castIds.forEach(cid => {
        const v = customerIds.reduce((s,cuId)=>s+(crossData[cuId][cid]||0),0);
        html += `<td>Â¥${v.toLocaleString()}</td>`;
    });
    const drinkGrandTotal = customerIds.reduce((s,cuId)=>s+Object.values(crossData[cuId]).reduce((ss,v)=>ss+v,0),0);
    html += `<td>Â¥${drinkGrandTotal.toLocaleString()}</td></tr>`;
    html += '</tbody></table></div>';
    document.getElementById('salesDetails').innerHTML = html;
}

// â”€â”€ é¡§å®¢è©³ç´° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCustomerDetail(customerId) {
    const cu = appData.customers.find(c=>c.id===customerId);
    if (!cu) return;
    const invs = appData.invoices.filter(i=>i.customerId===customerId);
    const totalSpent = invs.reduce((s,i)=>s+i.total,0);
    const totalDrinks = invs.reduce((s,i)=>s+i.drinks.reduce((ss,d)=>ss+d.count,0),0);
    const castDrinks = {};
    invs.forEach(i => i.drinks.forEach(d => {
        if (d.castId) castDrinks[d.castId] = (castDrinks[d.castId]||0) + d.count;
    }));
    const favCastId = Object.entries(castDrinks).sort((a,b)=>b[1]-a[1])[0]?.[0];
    const favCast = favCastId ? appData.casts.find(c=>c.id===favCastId) : null;
    const castSpend = {};
    invs.forEach(inv => {
        const drinksTot = inv.drinks.reduce((s,d)=>s+d.price*d.count,0);
        const base = inv.total - drinksTot;
        const castIds = [...new Set(inv.drinks.filter(d=>d.castId).map(d=>d.castId))];
        if (castIds.length) {
            const basePer = Math.round(base / castIds.length);
            castIds.forEach(cid => {
                const dAmt = inv.drinks.filter(d=>d.castId===cid).reduce((s,d)=>s+d.price*d.count,0);
                castSpend[cid] = (castSpend[cid]||0) + basePer + dAmt;
            });
        }
    });
    const castSpendSorted = Object.entries(castSpend).sort((a,b)=>b[1]-a[1]);
    document.getElementById('customerModalBody').innerHTML = `
        <div class="stat-grid">
            <div class="stat-card"><div class="stat-label">æ¥åº—å›æ•°</div><div class="stat-value">${invs.length}å›</div></div>
            <div class="stat-card"><div class="stat-label">ç·åˆ©ç”¨é¡</div><div class="stat-value">Â¥${totalSpent.toLocaleString()}</div></div>
            <div class="stat-card"><div class="stat-label">ãƒ‰ãƒªãƒ³ã‚¯æ•°</div><div class="stat-value">${totalDrinks}æ¯</div></div>
            <div class="stat-card"><div class="stat-label">ãŠæ°—ã«å…¥ã‚Š</div><div class="stat-value" style="font-size:16px;">${favCast?.name||'-'}</div></div>
        </div>
        <div style="margin-top:20px;">
            <div class="form-label">åŸºæœ¬æƒ…å ±</div>
            <div class="list-item">
                <div class="list-item-meta">èª•ç”Ÿæ—¥: ${cu.birthday||'æœªç™»éŒ²'}</div>
                ${cu.memo?`<div class="list-item-meta" style="margin-top:8px;">ãƒ¡ãƒ¢: ${cu.memo}</div>`:''}
            </div>
        </div>
        ${castSpendSorted.length ? `
        <div style="margin-top:20px;">
            <div class="form-label" style="color:var(--primary);">ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ä½¿ç”¨é¡</div>
            ${castSpendSorted.map(([cid,amt]) => {
                const cast = appData.casts.find(c=>c.id===cid);
                return `<div class="list-item"><div class="list-item-header"><div class="list-item-title">${cast?.name||'ä¸æ˜'}</div><span class="badge badge-primary">Â¥${amt.toLocaleString()}</span></div></div>`;
            }).join('')}
        </div>` : ''}
        <div style="margin-top:20px;">
            <div class="form-label">æ¥åº—å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰</div>
            ${invs.slice(-5).reverse().map(inv => {
                const date = new Date(inv.completedAt||inv.createdAt);
                const seatLbl = inv.seatPrice>0 ? ` / BOX${inv.boxNum?'#'+inv.boxNum:''}` : '';
                return `<div class="list-item"><div class="list-item-header"><div class="list-item-title">${date.toLocaleDateString('ja-JP')}</div><span class="badge badge-primary">Â¥${inv.total.toLocaleString()}</span></div><div class="list-item-meta">${inv.people||1}å${seatLbl} / ãƒ‰ãƒªãƒ³ã‚¯${inv.drinks.reduce((s,d)=>s+d.count,0)}æ¯</div></div>`;
            }).join('')}
        </div>
    `;
    openModal('customerModal');
}

// â”€â”€ ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function printReceipt(invoiceId) {
    const inv = appData.invoices.find(i => i.id === invoiceId);
    if (!inv) { alert('ç¢ºå®šæ¸ˆã¿ã®ä¼ç¥¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    const cu = appData.customers.find(c => c.id === inv.customerId);
    const dt = new Date(inv.completedAt || inv.createdAt);
    const dateStr = dt.toLocaleDateString('ja-JP', {year:'numeric', month:'long', day:'numeric'});
    const timeStr = dt.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
    const seatStr = inv.seatPrice > 0
        ? 'ãƒœãƒƒã‚¯ã‚¹å¸­' + (inv.boxNum ? ' #' + inv.boxNum : '') + ' (+Â¥1,000)'
        : 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­';
    const setLabel = inv.hasBottle ? 'ã‚»ãƒƒãƒˆæ–™é‡‘ï¼ˆãƒœãƒˆãƒ«æœ‰ï¼‰' : 'ã‚»ãƒƒãƒˆæ–™é‡‘ï¼ˆãƒœãƒˆãƒ«ç„¡ï¼‰';

    // ãƒ‰ãƒªãƒ³ã‚¯æ˜ç´°ã‚’ã‚­ãƒ£ã‚¹ãƒˆåä»˜ãã§çµ„ã¿ç«‹ã¦
    const drinkLines = [];
    const kleinerMap = {};
    inv.drinks.forEach(d => {
        if (d.shotType === 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼') {
            const key = d.castId || d.customerId || 'unknown';
            if (!kleinerMap[key]) kleinerMap[key] = { d, count: 0, castId: d.castId, customerId: d.customerId };
            kleinerMap[key].count += d.count;
        } else {
            const who = d.castId
                ? appData.casts.find(c => c.id === d.castId)?.name || ''
                : appData.customers.find(c => c.id === d.customerId)?.name || '';
            drinkLines.push({ name: d.name + (who ? 'ï¼ˆ' + who + 'ï¼‰' : ''), price: d.price, count: d.count });
        }
    });
    Object.values(kleinerMap).forEach(({ d, count, castId, customerId }) => {
        const who = castId
            ? appData.casts.find(c => c.id === castId)?.name || ''
            : appData.customers.find(c => c.id === customerId)?.name || '';
        const amt = Math.floor(count / 10) * 10 * 800 + (count % 10) * 1000;
        drinkLines.push({ name: 'ã‚¯ãƒ©ã‚¤ãƒŠãƒ¼' + (who ? 'ï¼ˆ' + who + 'ï¼‰' : ''), price: amt, count: 1, isTotalLine: true });
    });

    // å°è¨ˆã®çµ„ã¿ç«‹ã¦
    const rows = [];
    rows.push({ label: setLabel + ' Ã— ' + inv.people + 'å', price: inv.setPrice * inv.people });
    if (inv.seatPrice > 0) rows.push({ label: seatStr, price: inv.seatPrice });
    if (inv.extension > 0) {
        const extMins = inv.extension * 30;
        rows.push({ label: 'å»¶é•·ï¼ˆ' + extMins + 'åˆ†ï¼‰', price: inv.total - (inv.setPrice * inv.people + inv.seatPrice + inv.karaoke * 200 + drinkLines.reduce((s,d)=>s+d.price*(d.isTotalLine?1:d.count),0)) });
    }
    if (inv.karaoke > 0) rows.push({ label: 'ã‚«ãƒ©ã‚ªã‚± Ã— ' + inv.karaoke + 'æ›²', price: inv.karaoke * 200 });
    drinkLines.forEach(d => {
        const amt = d.isTotalLine ? d.price : d.price * d.count;
        const countStr = d.isTotalLine ? '' : ' Ã— ' + d.count;
        rows.push({ label: d.name + countStr, price: amt, indent: true });
    });

    const rowsHtml = rows.map(r =>
        '<div class="receipt-row' + (r.indent ? ' indent' : '') + '">' +
        '<span>' + r.label + '</span>' +
        '<span>Â¥' + r.price.toLocaleString() + '</span>' +
        '</div>'
    ).join('');

    const html = '<div class="receipt-wrap">' +
        '<div class="receipt-shop">SNACK 73</div>' +
        '<div class="receipt-sub">ã‚¹ãƒŠãƒƒã‚¯ã‚»ãƒ–ãƒ³ã‚¹ãƒªãƒ¼</div>' +
        '<hr class="receipt-divider">' +
        '<div class="receipt-row"><span>æ—¥æ™‚</span><span>' + dateStr + ' ' + timeStr + '</span></div>' +
        '<hr class="receipt-divider">' +
        rowsHtml +
        '<hr class="receipt-divider">' +
        '<div class="receipt-total-row"><span>åˆã€€è¨ˆ</span><span>Â¥' + inv.total.toLocaleString() + '</span></div>' +
        '<hr class="receipt-divider">' +
        '<div class="receipt-footer">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ<br>ã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™</div>' +
        '</div>';

    document.getElementById('receiptPrintArea').innerHTML = html;
    window.print();
}

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function renderCastSelects() {
    ['salaryCast','workCast'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const v = el.value;
        el.innerHTML = '<option value="">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</option>';
        appData.casts.forEach(c => { const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; el.appendChild(o); });
        el.value = v;
    });
}

function renderCustomerSelects() {
    const el = document.getElementById('editInvoiceCustomer');
    if (!el) return;
    const v = el.value;
    el.innerHTML = '<option value="">é¡§å®¢ã‚’é¸æŠ</option>';
    appData.customers.forEach(c => { const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; el.appendChild(o); });
    el.value = v;
}

function renderAll() {
    renderCastSelects();
    renderCustomerSelects();
    renderCastList();
    renderCustomerList();
    renderActiveInvoices();
    renderCompletedInvoices();
    renderDrinkSettings();
}
</script>
<!-- ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ã‚¨ãƒªã‚¢ï¼ˆå°åˆ·æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
<div id="receiptPrintArea"></div>

</body>
</html>
